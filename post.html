<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><title>New Thread</title>
    <link rel="stylesheet" href="./style.css"><script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#101010] text-white p-4 max-w-xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <button onclick="history.back()" class="text-zinc-400">キャンセル</button>
        <span class="font-bold" id="title">新しいスレッド</span>
        <button id="postBtn" class="bg-white text-black px-4 py-1.5 rounded-full font-bold opacity-50" disabled>投稿</button>
    </div>
    <div id="replyTarget" class="mb-4 opacity-50 text-sm"></div>
    <div class="flex gap-3">
        <div id="avatar" class="avatar-frame shrink-0"></div>
        <div class="w-full">
            <div id="username" class="font-bold text-sm mb-1"></div>
            <textarea id="content" placeholder="スレッドを開始..." class="w-full bg-transparent border-none focus:ring-0 text-[18px] h-60 resize-none"></textarea>
        </div>
    </div>
    <script type="module">
        import { supabase } from './lib/supabase.js';
        const params = new URLSearchParams(location.search);
        const replyTo = params.get('replyTo');

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            const { data: prof } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            
            document.getElementById('username').innerText = prof.username;
            if (prof.avatar_url) document.getElementById('avatar').innerHTML = `<img src="${prof.avatar_url}">`;

            if (replyTo) {
                document.getElementById('title').innerText = '返信';
                const { data: parent } = await supabase.from('posts').select('*').eq('id', replyTo).single();
                document.getElementById('replyTarget').innerText = `${parent.username}への返信: ${parent.content.substring(0, 20)}...`;
            }

            const btn = document.getElementById('postBtn');
            const txt = document.getElementById('content');
            txt.oninput = () => {
                btn.disabled = !txt.value.trim();
                btn.style.opacity = txt.value.trim() ? '1' : '0.5';
            };

            btn.onclick = async () => {
                await supabase.from('posts').insert({
                    user_id: user.id,
                    username: prof.username,
                    content: txt.value,
                    parent_id: replyTo ? parseInt(replyTo) : null
                });
                location.href = '/index.html';
            };
        }
        init();
    </script>
</body>
</html>
