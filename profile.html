<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><title>Profile</title>
    <link rel="stylesheet" href="./style.css"><script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#101010] text-white p-4 max-w-xl mx-auto pb-24">
    <div class="flex justify-between items-center mb-10">
        <h1 id="userLabel" class="text-2xl font-bold">プロフィール</h1>
        <button id="actionBtn" class="text-blue-500 font-bold">完了</button>
    </div>

    <div class="flex justify-between items-start mb-8">
        <div>
            <h2 id="fullName" class="text-2xl font-bold"></h2>
            <p id="usernameLabel" class="text-zinc-500">@username</p>
        </div>
        <div id="avatarDisp" class="w-20 h-20 rounded-full bg-zinc-800 overflow-hidden"></div>
    </div>
    <p id="bioDisp" class="mb-8 text-zinc-300"></p>

    <div id="editArea" class="space-y-4 hidden">
        <input id="avatarInput" type="text" placeholder="画像URL" class="w-full bg-zinc-900 p-4 rounded-xl">
        <textarea id="bioInput" placeholder="自己紹介" class="w-full bg-zinc-900 p-4 rounded-xl h-24"></textarea>
    </div>

    <div id="userPosts" class="divide-y divide-[#2a2a2a] border-t border-[#2a2a2a]"></div>

    <nav class="fixed bottom-0 left-0 right-0 max-w-xl mx-auto border-t border-[#2a2a2a] bg-[#101010] h-16 flex justify-around items-center px-4">
        <a href="/index.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></a>
        <a href="/post.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></a>
        <a href="/profile.html"><svg class="nav-icon active" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg></a>
    </nav>

    <script type="module">
        import { supabase } from './lib/supabase.js';
        const params = new URLSearchParams(location.search);
        const uid = params.get('uid');

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            const targetUid = uid || user.id;
            const isMe = targetUid === user.id;

            const { data: prof } = await supabase.from('profiles').select('*').eq('id', targetUid).single();
            
            document.getElementById('fullName').innerText = prof.username;
            document.getElementById('usernameLabel').innerText = `@${prof.username}`;
            document.getElementById('bioDisp').innerText = prof.bio || '自己紹介なし';
            if(prof.avatar_url) document.getElementById('avatarDisp').innerHTML = `<img src="${prof.avatar_url}" class="w-full h-full object-cover">`;

            if (isMe) {
                document.getElementById('editArea').classList.remove('hidden');
                document.getElementById('avatarInput').value = prof.avatar_url || '';
                document.getElementById('bioInput').value = prof.bio || '';
            } else {
                document.getElementById('actionBtn').innerText = 'フォロー';
            }

            document.getElementById('actionBtn').onclick = async () => {
                if(isMe) {
                    await supabase.from('profiles').update({
                        avatar_url: document.getElementById('avatarInput').value,
                        bio: document.getElementById('bioInput').value
                    }).eq('id', user.id);
                    location.reload();
                }
            };

            const { data: posts } = await supabase.from('posts').select('*').eq('user_id', targetUid).order('created_at', {ascending:false});
            posts.forEach(p => {
                const d = document.createElement('div');
                d.className = "py-4";
                d.innerHTML = `<p class="font-bold text-sm">${p.username}</p><p class="mt-1">${p.content}</p>`;
                document.getElementById('userPosts').appendChild(d);
            });
        }
        init();
    </script>
</body>
</html>
